@using System.Reflection
@using DrawflowWrapper.Models.NodeV2
@using Microsoft.AspNetCore.Components.Forms

<!-- Node editor modal -->
<div style="display:block;" class="modal fade show node-editor-modal"
     id="nodeEditorModal"
     tabindex="-1"
     aria-labelledby="nodeEditorLabel"
     aria-modal="true"
     role="dialog">
    <div class="modal-dialog node-editor-dialog">
        <div class="modal-content node-editor-content">
            <div class="modal-header node-editor-header">
                <div>
                    <h5 class="modal-title" id="nodeEditorLabel">Edit node</h5>
                    <p class="node-editor-subtitle">Payload based mapping</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body node-editor-body">
                <div class="node-editor-grid">
                    <!-- INPUT PANEL -->
                    <section class="node-editor-panel node-editor-panel-input">
                        <header class="panel-header">
                            <span class="pill pill-input">Input</span>
                            <h6>Incoming payload</h6>
                            <p class="panel-caption">Preview the payload that arrives at this node.</p>
                        </header>
                        <div class="panel-body">
                            <div class="payload-preview" data-role="payload-preview">
                                @IncomingPayloadJson
                            </div>

                            <div class="panel-section">
                                <div class="panel-section-header">
                                    <span>Fields</span>
                                    <button type="button"
                                            class="btn btn-xs btn-outline-secondary"
                                            data-role="refresh-payload">
                                        Refresh
                                    </button>
                                </div>
                                <div class="payload-field-list" data-role="payload-field-list">
                                    <!-- Example chip, clone these in JS -->
                                    <button type="button"
                                            class="payload-field-chip"
                                            data-role="payload-field"
                                            data-path="user.name">
                                        user.name
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- PROCESSING PANEL -->
                    <section class="node-editor-panel node-editor-panel-processing">
                        <header class="panel-header">
                            <span class="pill pill-processing">Processing</span>
                            <h6>Function mapping</h6>
                            <p class="panel-caption">Map payload fields into your function and back out again.</p>
                        </header>

                        <div class="panel-body panel-body-scroll">
                            <!-- Function input map -->
                            <div class="panel-section" data-role="function-input-map">
                                <div class="panel-section-header">
                                    <span>Function input map</span>
                                    <button onclick="@(() => ViewModel.NodeInputToMethodInputMap.Add(new()))" type="button"
                                            class="btn btn-xs btn-outline-secondary"
                                            data-role="add-input-mapping">
                                        Add mapping
                                    </button>
                                </div>

                                <div class="mapping-list" data-role="input-mapping-list">
                                    <!-- Template row; duplicate dynamically -->
                                    @foreach (var inputMapping in ViewModel.NodeInputToMethodInputMap)
                                    {
                                        <div class="mapping-row" data-role="input-mapping-row">
                                            <div class="mapping-col">
                                                <label>Payload path</label>
                                                <InputText @bind-Value="inputMapping.Input" type="text"
                                                       class="form-control form-control-sm"
                                                       placeholder="e.g. user.name"
                                                       data-role="payload-path" />
                                            </div>
                                            <div class="mapping-arrow">→</div>
                                            <div class="mapping-col">
                                                <label>Parameter</label>
                                                <InputSelect @bind-Value="inputMapping.Output" class="form-select form-select-sm" data-role="parameter-name">
                                                    <option value="">Select parameter…</option>
                                                    @foreach (var param in BackingNode?.BackingMethod?.GetParameters() ?? [])
                                                    {
                                                        <option value="@param.Name">(@param.ParameterType.Name) @param.Name</option>
                                                    }
                                                </InputSelect>
                                            </div>
                                            <button onclick="@(() => RemoveNodeInputToMethodInputMap(inputMapping))" type="button"
                                                    class="btn btn-icon btn-xs"
                                                    title="Remove"
                                                    data-role="remove-mapping">
                                                ✕
                                            </button>
                                        </div>
                                    }
                                </div>
                            </div>

                            <hr class="panel-divider" />

                            <!-- Function output map -->
                            <div class="panel-section" data-role="function-output-map">
                                <div class="panel-section-header">
                                    <span>Function output map</span>
                                    <button onclick="@(() => ViewModel.MethodOutputToNodeOutputMap.Add(new()))" type="button"
                                            class="btn btn-xs btn-outline-secondary"
                                            data-role="add-output-mapping">
                                        Add mapping
                                    </button>
                                </div>

                                <div class="mapping-list" data-role="output-mapping-list">
                                    @{ var propInfos = GetReturnProperties(); };
                                    @if (propInfos is not null)
                                    {
                                        @foreach (var outputMapping in ViewModel.MethodOutputToNodeOutputMap)
                                        {
                                            <div class="mapping-row" data-role="output-mapping-row">
                                                <div class="mapping-col">
                                                    <label>Function output</label>
                                                    <InputSelect @bind-Value="outputMapping.Input" class="form-select form-select-sm" data-role="function-output">
                                                        <option value="">Select output…</option>

                                                        @if (propInfos.Count() > 0)
                                                        {
                                                            @foreach (var property in propInfos)
                                                            {
                                                                <option value="@property.Name">(@property.PropertyType.Name) @property.Name</option>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <option value="result">(@BackingNode.BackingMethod.ReturnType.Name) result</option>
                                                        }

                                                    </InputSelect>
                                                </div>
                                                <div class="mapping-arrow">→</div>
                                                <div class="mapping-col">
                                                    <label>Payload path</label>
                                                    <InputText @bind-Value="outputMapping.Output" type="text"
                                                               class="form-control form-control-sm"
                                                               placeholder="e.g. result.value"
                                                               data-role="target-payload-path" />
                                                </div>
                                                <button onclick="@(() => RemoveMethodOutputToNodeOutputMap(outputMapping))" type="button"
                                                        class="btn btn-icon btn-xs"
                                                        title="Remove"
                                                        data-role="remove-mapping">
                                                    ✕
                                                </button>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- OUTPUT PANEL -->
                    <section class="node-editor-panel node-editor-panel-output">
                        <header class="panel-header">
                            <span class="pill pill-output">Output</span>
                            <h6>Resulting payload</h6>
                            <p class="panel-caption">See what leaves this node after mappings.</p>
                        </header>
                        <div class="panel-body">
                            <div class="payload-preview payload-preview--output"
                                 data-role="output-preview">
                                @OutputPayloadJson
                            </div>

                            <div class="panel-section">
                                <div class="panel-section-header">
                                    <span>Flags</span>
                                </div>

                                <div class="form-check form-switch">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="replacePayload"
                                           data-role="replace-payload" />
                                    <label class="form-check-label" for="replacePayload">
                                        Replace payload instead of merge
                                    </label>
                                </div>

                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="debugNode"
                                           data-role="debug-node" />
                                    <label class="form-check-label" for="debugNode">
                                        Capture debug snapshot
                                    </label>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <div class="modal-footer node-editor-footer">
                <button onclick="@(() => CloseRequested.InvokeAsync())" type="button"
                        class="btn btn-outline-secondary"
                        data-bs-dismiss="modal">
                    Cancel
                </button>
                <button onclick="@(() => SaveMappings())" type="button"
                        class="btn btn-primary"
                        data-role="save-node">
                    Save mappings
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback CloseRequested { get; set; }

    [Parameter]
    public required Node? BackingNode { get; set; }

    [Parameter]
    public string? IncomingPayloadJson { get; set; }

    [Parameter]
    public string? OutputPayloadJson { get; set; }

    public NodeEditorModalViewModel ViewModel { get; set; } = new();

    public PropertyInfo[]? GetReturnProperties()
    {
        var methodReturnType = BackingNode?.BackingMethod?.ReturnType;
        if (methodReturnType == typeof(void) || methodReturnType == typeof(Task))
        {
            return null;
        }

        var returnProperties = methodReturnType?.GetProperties(BindingFlags.Instance | BindingFlags.Public) ?? [];
        return returnProperties;
    }

    private void SaveMappings()
    {
        BackingNode.MethodOutputToNodeOutputMap = ViewModel.MethodOutputToNodeOutputMap.ToDictionary(x => x.Input, x => x.Output);
        BackingNode.NodeInputToMethodInputMap = ViewModel.NodeInputToMethodInputMap.ToDictionary(x => x.Input, x => x.Output);
    }

    private void RemoveMethodOutputToNodeOutputMap(InputOutputMapViewModel viewModel)
    {
        ViewModel.MethodOutputToNodeOutputMap.Remove(viewModel);
        StateHasChanged();
    }

    private void RemoveNodeInputToMethodInputMap(InputOutputMapViewModel viewModel)
    {
        ViewModel.NodeInputToMethodInputMap.Remove(viewModel);
        StateHasChanged();
    }

    public class NodeEditorModalViewModel 
    {
        public List<InputOutputMapViewModel> NodeInputToMethodInputMap { get; set; } = [new()];
        public List<InputOutputMapViewModel> MethodOutputToNodeOutputMap { get; set; } = [new()];
    }

    public class InputOutputMapViewModel
    {
        public string Input { get; set; } = "";
        public string Output { get; set; } = "";
    }
}