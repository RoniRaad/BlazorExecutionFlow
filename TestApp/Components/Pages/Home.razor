@page "/"
@using DrawflowWrapper.Components
@using DrawflowWrapper.Drawflow.BaseNodes
@using DrawflowWrapper.Helpers
@using DrawflowWrapper.Models
@using DrawflowWrapper.Models.NodeV2
@using System.Text.Json
@using static DrawflowWrapper.Helpers.DrawflowHelpers

<h1>Drawflow Blazor Wrapper Demo</h1>

@if (showModal && editNode is not null)
{
    <NodeEditorModal SaveRequested=SaveChanges CloseRequested="@(() => showModal = false)" BackingNode="@(editNode)"></NodeEditorModal>
}

<div style="display:flex;;flex-direction: row;">
    <div style="display:flex;margin-bottom:5px;flex-direction: column;margin-right: 8px;width: 350px;">
        <div style="display:flex;justify-content: space-between;margin-bottom:8px">
            <button class="btn btn-sm btn-primary" @onclick="ImportTest">ImportTest</button>
            <button class="btn btn-sm btn-primary" @onclick="Export">Export</button>
            <button class="btn btn-sm btn-primary" @onclick="Clear">Clear</button>
            <button class="btn btn-sm btn-primary" @onclick="Run">Run</button>
        </div>
        <div style="display: flex;gap: 5px;overflow:auto;flex-direction: column;height:80vh" class="controls">
            @foreach (var nodeGroup in _nodes.GroupBy(x => x.Section))
            {
                <div class="accordion" id="accordion-@nodeGroup.FirstOrDefault()?.Section.GetHashCode()">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-@nodeGroup.FirstOrDefault()?.Section.GetHashCode()">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@nodeGroup.FirstOrDefault()?.Section.GetHashCode()" aria-expanded="true" aria-controls="collapse-@nodeGroup.FirstOrDefault()?.Section.GetHashCode()">
                                @nodeGroup.FirstOrDefault()?.Section
                            </button>
                        </h2>
                        <div id="collapse-@nodeGroup.FirstOrDefault()?.Section.GetHashCode()" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordion-@nodeGroup.FirstOrDefault()?.Section.GetHashCode()">
                            <div class="accordion-body" style="display: flex;flex-wrap: wrap;gap: 5px;">
                                @foreach (var node in nodeGroup)
                                {
                                    <button class="btn btn-sm btn-primary" @onclick="@(() => CreateNode(node))">@node.BackingMethod.Name</button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }


        </div>
    </div>
    <Drawflow @ref="_base"
    Id="df-demo"
    Style="height:600px;"
    Options="@options"
    OnEvent="HandleEvent"
    OnNodeDoubleClicked="DoubleClickedNode" />
</div>

@if (!string.IsNullOrWhiteSpace(_exportJson))
{
    <pre style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;border-radius:8px;max-height:240px;overflow:auto;">@_exportJson</pre>
}

@code {
    private Dictionary<string, object> options = new Dictionary<string, object>() { ["reroute"] = true };
    private DrawflowBase? _base;
    private string? _exportJson;
    private List<Node> _nodes = [];
    private bool showModal = false;
    private Node? editNode = null;

    private async Task ImportTest()
    {
        await _base.CallAsync("import", "{\"drawflow\":{\"Home\":{\"data\":{\"1\":{\"id\":1,\"name\":\"Start\",\"data\":{\"node\":{\"backingMethod\":{\"declaringType\":\"DrawflowWrapper.Drawflow.BaseNodes.BaseNodeCollection,DrawflowWrapper,Version=1.0.0.0,Culture=neutral,PublicKeyToken=null\",\"methodName\":\"Start\",\"parameterTypes\":[]},\"id\":\"ec4e886c-f3f8-4489-807a-64a8e00d171d\",\"section\":\"Events\",\"drawflowNodeId\":\"\",\"posX\":0,\"posY\":0,\"nodeInputToMethodInputMap\":[],\"methodOutputToNodeOutputMap\":[],\"input\":null,\"result\":null,\"mergeOutputWithInput\":false,\"declaredOutputPorts\":[]},\"outputPorts\":[]},\"class\":\"\",\"html\":\"\r\n\u003Cdivclass=\u0027node-type-id-container\u0027\u003E\r\n\u003Ch5class=\u0027node-type-id\u0027\u003E\r\n\u0192\r\n\u003C/h5\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027title-container\u0027\u003E\r\n\u003Cdivclass=\u0027title\u0027style=\u0027text-align:center;\u0027\u003EStart\u003C/div\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027main-content\u0027style=\u0027min-width:300px\u0027\u003E\r\n\r\n\u003C/div\u003E\r\n\",\"typenode\":false,\"inputs\":{\"input_1\":{\"connections\":[]}},\"outputs\":{\"output_1\":{\"connections\":[{\"node\":\"3\",\"output\":\"input_1\"}]}},\"pos_x\":217,\"pos_y\":251},\"2\":{\"id\":2,\"name\":\"CreatePerson\",\"data\":{\"node\":{\"backingMethod\":{\"declaringType\":\"DrawflowWrapper.Drawflow.BaseNodes.BaseNodeCollection,DrawflowWrapper,Version=1.0.0.0,Culture=neutral,PublicKeyToken=null\",\"methodName\":\"CreatePerson\",\"parameterTypes\":[]},\"id\":\"de3cda6d-298a-456b-b382-e4605458599d\",\"section\":\"Test\",\"drawflowNodeId\":\"\",\"posX\":0,\"posY\":0,\"nodeInputToMethodInputMap\":[],\"methodOutputToNodeOutputMap\":[{\"from\":\"Name\",\"to\":\"name\"},{\"from\":\"Height\",\"to\":\"height\"}],\"input\":null,\"result\":null,\"mergeOutputWithInput\":false,\"declaredOutputPorts\":[]},\"outputPorts\":[]},\"class\":\"\",\"html\":\"\r\n\u003Cdivclass=\u0027node-type-id-container\u0027\u003E\r\n\u003Ch5class=\u0027node-type-id\u0027\u003E\r\n\u0192\r\n\u003C/h5\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027title-container\u0027\u003E\r\n\u003Cdivclass=\u0027title\u0027style=\u0027text-align:center;\u0027\u003ECreatePerson\u003C/div\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027main-content\u0027style=\u0027min-width:300px\u0027\u003E\r\n\r\n\u003C/div\u003E\r\n\",\"typenode\":false,\"inputs\":{\"input_1\":{\"connections\":[{\"node\":\"3\",\"input\":\"output_1\"}]}},\"outputs\":{\"output_1\":{\"connections\":[]}},\"pos_x\":615,\"pos_y\":222},\"3\":{\"id\":3,\"name\":\"For\",\"data\":{\"node\":{\"backingMethod\":{\"declaringType\":\"DrawflowWrapper.Drawflow.BaseNodes.BaseNodeCollection,DrawflowWrapper,Version=1.0.0.0,Culture=neutral,PublicKeyToken=null\",\"methodName\":\"For\",\"parameterTypes\":[\"DrawflowWrapper.Models.NodeV2.NodeContext,DrawflowWrapper,Version=1.0.0.0,Culture=neutral,PublicKeyToken=null\",\"System.Int32,System.Private.CoreLib,Version=8.0.0.0,Culture=neutral,PublicKeyToken=7cec85d7bea7798e\",\"System.Int32,System.Private.CoreLib,Version=8.0.0.0,Culture=neutral,PublicKeyToken=7cec85d7bea7798e\"]},\"id\":\"006538ad-e6f4-4fb4-a665-c9194ec04f11\",\"section\":\"Conditionals\",\"drawflowNodeId\":\"\",\"posX\":0,\"posY\":0,\"nodeInputToMethodInputMap\":[],\"methodOutputToNodeOutputMap\":[],\"input\":null,\"result\":null,\"mergeOutputWithInput\":false,\"declaredOutputPorts\":[\"done\",\"loop\"]},\"outputPorts\":[\"done\",\"loop\"]},\"class\":\"\",\"html\":\"\r\n\u003Cdivclass=\u0027node-type-id-container\u0027\u003E\r\n\u003Ch5class=\u0027node-type-id\u0027\u003E\r\n\u0192\r\n\u003C/h5\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027title-container\u0027\u003E\r\n\u003Cdivclass=\u0027title\u0027style=\u0027text-align:center;\u0027\u003EFor\u003C/div\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027main-content\u0027style=\u0027min-width:300px\u0027\u003E\r\n\r\n\u003C/div\u003E\r\n\",\"typenode\":false,\"inputs\":{\"input_1\":{\"connections\":[{\"node\":\"1\",\"input\":\"output_1\"}]}},\"outputs\":{\"output_1\":{\"connections\":[{\"node\":\"2\",\"output\":\"input_1\"}]},\"output_2\":{\"connections\":[{\"node\":\"4\",\"output\":\"input_1\"}]}},\"pos_x\":390,\"pos_y\":238},\"4\":{\"id\":4,\"name\":\"CreatePerson\",\"data\":{\"node\":{\"backingMethod\":{\"declaringType\":\"DrawflowWrapper.Drawflow.BaseNodes.BaseNodeCollection,DrawflowWrapper,Version=1.0.0.0,Culture=neutral,PublicKeyToken=null\",\"methodName\":\"CreatePerson\",\"parameterTypes\":[]},\"id\":\"de3cda6d-298a-456b-b382-e4605458599d\",\"section\":\"Test\",\"drawflowNodeId\":\"\",\"posX\":0,\"posY\":0,\"nodeInputToMethodInputMap\":[],\"methodOutputToNodeOutputMap\":[{\"from\":\"Name\",\"to\":\"name\"},{\"from\":\"Height\",\"to\":\"height\"}],\"input\":null,\"result\":null,\"mergeOutputWithInput\":false,\"declaredOutputPorts\":[]},\"outputPorts\":[]},\"class\":\"\",\"html\":\"\r\n\u003Cdivclass=\u0027node-type-id-container\u0027\u003E\r\n\u003Ch5class=\u0027node-type-id\u0027\u003E\r\n\u0192\r\n\u003C/h5\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027title-container\u0027\u003E\r\n\u003Cdivclass=\u0027title\u0027style=\u0027text-align:center;\u0027\u003ECreatePerson\u003C/div\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027main-content\u0027style=\u0027min-width:300px\u0027\u003E\r\n\r\n\u003C/div\u003E\r\n\",\"typenode\":false,\"inputs\":{\"input_1\":{\"connections\":[{\"node\":\"3\",\"input\":\"output_2\"}]}},\"outputs\":{\"output_1\":{\"connections\":[]}},\"pos_x\":624,\"pos_y\":304}}}}}");
    }

    private async Task SaveChanges()
    {
        var graph = await _base.CreateInternalV2Graph().ConfigureAwait(false);
        var currentUiNode = graph.Nodes.First(x => x.Key == editNode.DrawflowNodeId);
        editNode.PosX = currentUiNode.Value.PosX;
        editNode.PosY = currentUiNode.Value.PosY;
        graph.Nodes[editNode.DrawflowNodeId] = editNode;
        var json = DrawflowExporter.ExportToDrawflowJson(graph.Nodes.Select(x => x.Value));
        await _base.CallAsync("import", json);

        await _base.JS.InvokeVoidAsync("nextFrame");

        foreach (var node in graph.Nodes)
        {
            if (node.Value.OutputPorts.Count > 1)
            {
                await _base.JS.InvokeVoidAsync("DrawflowBlazor.labelPorts", _base.Id, node.Value.DrawflowNodeId, new List<List<string>>(), node.Value.DeclaredOutputPorts.Select(x => new List<string>() { x, "" }));
            }
        }
    }

    async Task SetStatusAsync(string nodeId, bool isRunning, int? outputPos = null, object? value = null)
    {
        var status = new NodeStatus { IsRunning = isRunning };
        if (outputPos is not null)
        {
            status.OutputPortResults[outputPos.Value] = value!;
        }
        await _base.SetNodeStatus(nodeId, status).ConfigureAwait(false);
    }

    private async Task Run()
    {
        var graph = await _base.CreateInternalV2Graph().ConfigureAwait(false);
        foreach (var node in graph.Nodes)
        {
            node.Value.Result = null;
            node.Value.OnStartExecuting += (x, y) => { _ = SetStatusAsync(node.Value.DrawflowNodeId, true); };
            node.Value.OnStopExecuting += (x, y) => { _ = SetStatusAsync(node.Value.DrawflowNodeId, false); };
        }

        var startNodes = graph.Nodes.Where(x => x.Value.BackingMethod.Name == "Start");
        var tasks = new List<Task>();
        foreach (var startNode in startNodes)
        {
            tasks.Add(startNode.Value.ExecuteNode());
        }

        _ = Task.WhenAll(tasks).ContinueWith(async x =>
        {
            var json = DrawflowExporter.ExportToDrawflowJson(graph.Nodes.Select(x => x.Value));
            await _base.CallAsync("import", json);
            await _base.JS.InvokeVoidAsync("nextFrame");

            foreach (var node in graph.Nodes)
            {
                if (node.Value.OutputPorts.Count > 1)
                {
                    await _base.JS.InvokeVoidAsync("DrawflowBlazor.labelPorts", _base.Id, node.Value.DrawflowNodeId, new List<List<string>>(), node.Value.DeclaredOutputPorts.Select(x => new List<string>() { x, "" }));
                }
            }
        });

    }

    private async Task CreateNode(Node node)
    {
        var returnProps = TypeHelpers.GetReturnProperties(node.BackingMethod);

        if (returnProps is null)
        {
            await _base.CreateNodeV2(node, "ƒ");
            return;
        }

        // "β" "♾️"

        node.MethodOutputToNodeOutputMap = returnProps.Select(x => new PathMapEntry() { From = x.Name, To = $"{char.ToLower(x.Name[0])}{x.Name[1..]}" }).ToList();
        node.NodeInputToMethodInputMap = node.BackingMethod.GetParameters().Select(x => new PathMapEntry() { From = "", To = $"{char.ToLower(x.Name[0])}{x.Name[1..]}" }).ToList();
        await _base.CreateNodeV2(node, "ƒ");
    }

    private async Task HandleEvent(DrawflowEventArgs e)
    {
        await InvokeAsync(StateHasChanged);
    }

    private async Task DoubleClickedNode(string nodeId)
    {
        var graph = await _base.CreateInternalV2Graph();
        var node = graph.Nodes.FirstOrDefault(x => x.Key == nodeId.ToString());
        editNode = node.Value;
        showModal = true;

        await InvokeAsync(StateHasChanged);
    }

    protected override void OnInitialized()
    {
        _nodes = DrawflowHelpers.GetNodesObjectsV2();
        base.OnInitialized();
    }

    private async Task Export()
    {
        if (_base is null) return;
        var exported = await _base.CallAsync<object>("export");
        _exportJson = System.Text.Json.JsonSerializer.Serialize(exported, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
    }

    private async Task Clear()
    {
        if (_base is null) return;
        await _base.CallAsync<object>("clear");
        _exportJson = null;
    }
}
