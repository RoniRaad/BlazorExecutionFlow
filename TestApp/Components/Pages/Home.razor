@page "/"
@using DrawflowWrapper.Components
@using DrawflowWrapper.Drawflow.BaseNodes
@using DrawflowWrapper.Helpers
@using DrawflowWrapper.Models
@using DrawflowWrapper.Models.NodeV2
@using System.Text.Json
@using static DrawflowWrapper.Helpers.DrawflowHelpers

<PageTitle>Workflow Designer - DrawFlow</PageTitle>

<div class="page-header">
    <div>
        <h1>Workflow Designer</h1>
        <p class="page-description">Create and execute visual node-based workflows with drag-and-drop simplicity</p>
    </div>
    <div class="page-stats">
        <div class="stat-item">
            <span class="stat-value">@_nodes.Count</span>
            <span class="stat-label">Available Nodes</span>
        </div>
    </div>
</div>

@if (showModal && editNode is not null)
{
    <NodeEditorModal SaveRequested=SaveChanges CloseRequested="@(() => showModal = false)" BackingNode="@(editNode)"></NodeEditorModal>
}

<div class="drawflow-container">
    <div class="sidebar-panel">
        <div class="control-buttons">
            <button class="btn btn-sm btn-primary" @onclick="ImportTest" aria-label="Import test data">ImportTest</button>
            <button class="btn btn-sm btn-success" @onclick="ExportCSharp" aria-label="Export to C# JSON">Export C#</button>
            <button class="btn btn-sm btn-info" @onclick="() => showImportModal = true" aria-label="Import from C# JSON">Import C#</button>
            <button class="btn btn-sm btn-primary" @onclick="Clear" aria-label="Clear workflow">Clear</button>
            <button class="btn btn-sm btn-primary" @onclick="Run" aria-label="Run workflow">Run</button>
        </div>
        <div class="node-browser">
            <div class="node-search">
                <input type="text"
                       class="form-control"
                       placeholder="Search nodes..."
                       @bind="searchQuery"
                       @bind:event="oninput"
                       aria-label="Search nodes" />
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
            </div>

            <div class="category-filters">
                <button class="category-pill @(selectedCategory == null ? "active" : "")"
                        @onclick="@(() => selectedCategory = null)"
                        aria-label="Show all categories">
                    All
                </button>
                @foreach (var category in Categories)
                {
                    <button class="category-pill @(selectedCategory == category ? "active" : "")"
                            @onclick="@(() => selectedCategory = category)"
                            aria-label="Filter by @category">
                        @category
                    </button>
                }
            </div>

            <div class="node-list">
                @if (FilteredNodes.Any())
                {
                    @foreach (var node in FilteredNodes)
                    {
                        <button class="node-item"
                                @onclick="@(() => CreateNode(node))"
                                aria-label="Create @node.BackingMethod.Name node">
                            <span class="node-name">@node.BackingMethod.Name</span>
                            <span class="node-category">@node.Section</span>
                        </button>
                    }
                }
                else
                {
                    <div class="no-results">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 8v4"></path>
                            <path d="M12 16h.01"></path>
                        </svg>
                        <p>No nodes found</p>
                    </div>
                }
            </div>
        </div>
    </div>
    <Drawflow @ref="_base"
    Id="df-demo"
    Style="height:600px;"
    Options="@options"
    OnEvent="HandleEvent"
    OnNodeDoubleClicked="DoubleClickedNode"
    Graph="graph" />
</div>

@if (!string.IsNullOrWhiteSpace(_exportJson))
{
    <div class="export-modal-backdrop" @onclick="() => _exportJson = null">
        <div class="export-modal" @onclick:stopPropagation="true">
            <div class="export-modal-header">
                <h3>C# Flow Export</h3>
                <button class="btn-close" @onclick="() => _exportJson = null">×</button>
            </div>
            <div class="export-modal-body">
                <button class="btn btn-sm btn-primary mb-2" @onclick="CopyToClipboard">Copy to Clipboard</button>
                <textarea class="export-textarea" readonly>@_exportJson</textarea>
            </div>
        </div>
    </div>
}

@if (showImportModal)
{
    <div class="export-modal-backdrop" @onclick="() => showImportModal = false">
        <div class="export-modal" @onclick:stopPropagation="true">
            <div class="export-modal-header">
                <h3>Import C# Flow</h3>
                <button class="btn-close" @onclick="() => showImportModal = false">×</button>
            </div>
            <div class="export-modal-body">
                <textarea class="export-textarea" @bind="_importJson" placeholder="Paste C# Flow JSON here..."></textarea>
                <div class="mt-2">
                    <button class="btn btn-sm btn-primary" @onclick="ImportCSharp">Import</button>
                    <button class="btn btn-sm btn-secondary" @onclick="() => showImportModal = false">Cancel</button>
                </div>
                @if (!string.IsNullOrWhiteSpace(_importError))
                {
                    <div class="alert alert-danger mt-2">@_importError</div>
                }
            </div>
        </div>
    </div>
}

@code {
    private Dictionary<string, object> options = new Dictionary<string, object>() { ["reroute"] = true };
    private DrawflowBase? _base;
    private string? _exportJson;
    private string? _importJson;
    private string? _importError;
    private List<Node> _nodes = [];
    private bool showModal = false;
    private bool showImportModal = false;
    private Node? editNode = null;
    private Graph graph = new();

    private string searchQuery = string.Empty;
    private string? selectedCategory = null;

    private IEnumerable<string> Categories => _nodes
        .Select(n => n.Section)
        .Distinct()
        .OrderBy(s => s);

    private IEnumerable<Node> FilteredNodes
    {
        get
        {
            var filtered = _nodes.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                filtered = filtered.Where(n =>
                    n.BackingMethod.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                    n.Section.Contains(searchQuery, StringComparison.OrdinalIgnoreCase));
            }

            if (selectedCategory != null)
            {
                filtered = filtered.Where(n => n.Section == selectedCategory);
            }

            return filtered.OrderBy(n => n.Section).ThenBy(n => n.BackingMethod.Name);
        }
    }

    private async Task ImportTest()
    {
        await _base.CallAsync("import", "{\"drawflow\":{\"Home\":{\"data\":{\"1\":{\"id\":1,\"name\":\"Start\",\"data\":{\"node\":{\"backingMethod\":{\"declaringType\":\"DrawflowWrapper.Drawflow.BaseNodes.BaseNodeCollection,DrawflowWrapper,Version=1.0.0.0,Culture=neutral,PublicKeyToken=null\",\"methodName\":\"Start\",\"parameterTypes\":[]},\"id\":\"ec4e886c-f3f8-4489-807a-64a8e00d171d\",\"section\":\"Events\",\"drawflowNodeId\":\"\",\"posX\":0,\"posY\":0,\"nodeInputToMethodInputMap\":[],\"methodOutputToNodeOutputMap\":[],\"input\":null,\"result\":null,\"mergeOutputWithInput\":false,\"declaredOutputPorts\":[]},\"outputPorts\":[]},\"class\":\"\",\"html\":\"\r\n\u003Cdivclass=\u0027node-type-id-container\u0027\u003E\r\n\u003Ch5class=\u0027node-type-id\u0027\u003E\r\n\u0192\r\n\u003C/h5\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027title-container\u0027\u003E\r\n\u003Cdivclass=\u0027title\u0027style=\u0027text-align:center;\u0027\u003EStart\u003C/div\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027main-content\u0027style=\u0027min-width:300px\u0027\u003E\r\n\r\n\u003C/div\u003E\r\n\",\"typenode\":false,\"inputs\":{\"input_1\":{\"connections\":[]}},\"outputs\":{\"output_1\":{\"connections\":[{\"node\":\"3\",\"output\":\"input_1\"}]}},\"pos_x\":217,\"pos_y\":251},\"2\":{\"id\":2,\"name\":\"CreatePerson\",\"data\":{\"node\":{\"backingMethod\":{\"declaringType\":\"DrawflowWrapper.Drawflow.BaseNodes.BaseNodeCollection,DrawflowWrapper,Version=1.0.0.0,Culture=neutral,PublicKeyToken=null\",\"methodName\":\"CreatePerson\",\"parameterTypes\":[]},\"id\":\"de3cda6d-298a-456b-b382-e4605458599d\",\"section\":\"Test\",\"drawflowNodeId\":\"\",\"posX\":0,\"posY\":0,\"nodeInputToMethodInputMap\":[],\"methodOutputToNodeOutputMap\":[{\"from\":\"Name\",\"to\":\"name\"},{\"from\":\"Height\",\"to\":\"height\"}],\"input\":null,\"result\":null,\"mergeOutputWithInput\":false,\"declaredOutputPorts\":[]},\"outputPorts\":[]},\"class\":\"\",\"html\":\"\r\n\u003Cdivclass=\u0027node-type-id-container\u0027\u003E\r\n\u003Ch5class=\u0027node-type-id\u0027\u003E\r\n\u0192\r\n\u003C/h5\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027title-container\u0027\u003E\r\n\u003Cdivclass=\u0027title\u0027style=\u0027text-align:center;\u0027\u003ECreatePerson\u003C/div\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027main-content\u0027style=\u0027min-width:300px\u0027\u003E\r\n\r\n\u003C/div\u003E\r\n\",\"typenode\":false,\"inputs\":{\"input_1\":{\"connections\":[{\"node\":\"3\",\"input\":\"output_1\"}]}},\"outputs\":{\"output_1\":{\"connections\":[]}},\"pos_x\":615,\"pos_y\":222},\"3\":{\"id\":3,\"name\":\"For\",\"data\":{\"node\":{\"backingMethod\":{\"declaringType\":\"DrawflowWrapper.Drawflow.BaseNodes.BaseNodeCollection,DrawflowWrapper,Version=1.0.0.0,Culture=neutral,PublicKeyToken=null\",\"methodName\":\"For\",\"parameterTypes\":[\"DrawflowWrapper.Models.NodeV2.NodeContext,DrawflowWrapper,Version=1.0.0.0,Culture=neutral,PublicKeyToken=null\",\"System.Int32,System.Private.CoreLib,Version=8.0.0.0,Culture=neutral,PublicKeyToken=7cec85d7bea7798e\",\"System.Int32,System.Private.CoreLib,Version=8.0.0.0,Culture=neutral,PublicKeyToken=7cec85d7bea7798e\"]},\"id\":\"006538ad-e6f4-4fb4-a665-c9194ec04f11\",\"section\":\"Conditionals\",\"drawflowNodeId\":\"\",\"posX\":0,\"posY\":0,\"nodeInputToMethodInputMap\":[],\"methodOutputToNodeOutputMap\":[],\"input\":null,\"result\":null,\"mergeOutputWithInput\":false,\"declaredOutputPorts\":[\"done\",\"loop\"]},\"outputPorts\":[\"done\",\"loop\"]},\"class\":\"\",\"html\":\"\r\n\u003Cdivclass=\u0027node-type-id-container\u0027\u003E\r\n\u003Ch5class=\u0027node-type-id\u0027\u003E\r\n\u0192\r\n\u003C/h5\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027title-container\u0027\u003E\r\n\u003Cdivclass=\u0027title\u0027style=\u0027text-align:center;\u0027\u003EFor\u003C/div\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027main-content\u0027style=\u0027min-width:300px\u0027\u003E\r\n\r\n\u003C/div\u003E\r\n\",\"typenode\":false,\"inputs\":{\"input_1\":{\"connections\":[{\"node\":\"1\",\"input\":\"output_1\"}]}},\"outputs\":{\"output_1\":{\"connections\":[{\"node\":\"2\",\"output\":\"input_1\"}]},\"output_2\":{\"connections\":[{\"node\":\"4\",\"output\":\"input_1\"}]}},\"pos_x\":390,\"pos_y\":238},\"4\":{\"id\":4,\"name\":\"CreatePerson\",\"data\":{\"node\":{\"backingMethod\":{\"declaringType\":\"DrawflowWrapper.Drawflow.BaseNodes.BaseNodeCollection,DrawflowWrapper,Version=1.0.0.0,Culture=neutral,PublicKeyToken=null\",\"methodName\":\"CreatePerson\",\"parameterTypes\":[]},\"id\":\"de3cda6d-298a-456b-b382-e4605458599d\",\"section\":\"Test\",\"drawflowNodeId\":\"\",\"posX\":0,\"posY\":0,\"nodeInputToMethodInputMap\":[],\"methodOutputToNodeOutputMap\":[{\"from\":\"Name\",\"to\":\"name\"},{\"from\":\"Height\",\"to\":\"height\"}],\"input\":null,\"result\":null,\"mergeOutputWithInput\":false,\"declaredOutputPorts\":[]},\"outputPorts\":[]},\"class\":\"\",\"html\":\"\r\n\u003Cdivclass=\u0027node-type-id-container\u0027\u003E\r\n\u003Ch5class=\u0027node-type-id\u0027\u003E\r\n\u0192\r\n\u003C/h5\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027title-container\u0027\u003E\r\n\u003Cdivclass=\u0027title\u0027style=\u0027text-align:center;\u0027\u003ECreatePerson\u003C/div\u003E\r\n\u003C/div\u003E\r\n\u003Cdivclass=\u0027main-content\u0027style=\u0027min-width:300px\u0027\u003E\r\n\r\n\u003C/div\u003E\r\n\",\"typenode\":false,\"inputs\":{\"input_1\":{\"connections\":[{\"node\":\"3\",\"input\":\"output_2\"}]}},\"outputs\":{\"output_1\":{\"connections\":[]}},\"pos_x\":624,\"pos_y\":304}}}}}");
    }

    private async Task SaveChanges()
    {
        var currentUiNode = graph.Nodes.First(x => x.Key == editNode.DrawflowNodeId);
        editNode.PosX = currentUiNode.Value.PosX;
        editNode.PosY = currentUiNode.Value.PosY;
        graph.Nodes[editNode.DrawflowNodeId] = editNode;
        var json = DrawflowExporter.ExportToDrawflowJson(graph.Nodes.Select(x => x.Value));
        await _base.CallAsync("import", json);

        await _base.JS.InvokeVoidAsync("nextFrame");

        foreach (var node in graph.Nodes)
        {
            if (node.Value.DeclaredOutputPorts.Count > 0)
            {
                await _base.JS.InvokeVoidAsync("DrawflowBlazor.labelPorts", _base.Id, node.Value.DrawflowNodeId, new List<List<string>>(), node.Value.DeclaredOutputPorts.Select(x => new List<string>() { x, "" }));
            }
        }
    }

    async Task SetStatusAsync(string nodeId, bool isRunning, int? outputPos = null, object? value = null)
    {
        var status = new NodeStatus { IsRunning = isRunning };
        if (outputPos is not null)
        {
            status.OutputPortResults[outputPos.Value] = value!;
        }
        await _base.SetNodeStatus(nodeId, status);
    }

    private async Task Run()
    {
        foreach (var node in graph.Nodes)
        {
            node.Value.Result = null;
            node.Value.OnStartExecuting += (x, y) => { _ = SetStatusAsync(node.Value.DrawflowNodeId, true); };
            node.Value.OnStopExecuting += (x, y) => { _ = SetStatusAsync(node.Value.DrawflowNodeId, false); };
        }

        var startNodes = graph.Nodes.Where(x => x.Value.BackingMethod.Name == "Start");
        var tasks = new List<Task>();
        foreach (var startNode in startNodes)
        {
            tasks.Add(startNode.Value.ExecuteNode());
        }

        await Task.WhenAll(tasks);

        // Re-import the graph with execution results
        var json = DrawflowExporter.ExportToDrawflowJson(graph.Nodes.Select(x => x.Value));
        await _base.CallAsync("import", json);
        await _base.JS.InvokeVoidAsync("nextFrame");

        // Re-apply port labels for nodes with multiple outputs
        foreach (var node in graph.Nodes)
        {
            if (node.Value.DeclaredOutputPorts.Count > 0)
            {
                await _base.JS.InvokeVoidAsync("DrawflowBlazor.labelPorts", _base.Id, node.Value.DrawflowNodeId, new List<List<string>>(), node.Value.DeclaredOutputPorts.Select(x => new List<string>() { x, "" }));
            }
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task CreateNode(Node node)
    {
        var returnProps = TypeHelpers.GetReturnProperties(node.BackingMethod);

        if (returnProps is null)
        {
            node.DrawflowNodeId = (await _base.CreateNodeV2(node, "ƒ")).ToString();
            graph.Nodes[node.DrawflowNodeId] = node;
            return;
        }

        // "β" "♾️"

        node.MethodOutputToNodeOutputMap = returnProps.Select(x => new PathMapEntry() { From = x.Name, To = $"{char.ToLower(x.Name[0])}{x.Name[1..]}" }).ToList();
        node.NodeInputToMethodInputMap = node.BackingMethod.GetParameters().Select(x => new PathMapEntry() { From = "", To = $"{char.ToLower(x.Name[0])}{x.Name[1..]}" }).ToList();
        node.DrawflowNodeId = (await _base.CreateNodeV2(node, "ƒ")).ToString();
        graph.Nodes[node.DrawflowNodeId] = node;
    }

    private async Task HandleEvent(DrawflowEventArgs e)
    {
        await InvokeAsync(StateHasChanged);
    }

    private async Task DoubleClickedNode(string nodeId)
    {
        var node = graph.Nodes.FirstOrDefault(x => x.Key == nodeId.ToString());
        editNode = node.Value;
        showModal = true;

        await InvokeAsync(StateHasChanged);
    }

    protected override void OnInitialized()
    {
        _nodes = DrawflowHelpers.GetNodesObjectsV2();
        base.OnInitialized();
    }

    private async Task Export()
    {
        if (_base is null) return;
        var exported = await _base.CallAsync<object>("export");
        _exportJson = System.Text.Json.JsonSerializer.Serialize(exported, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
    }

    private async Task ExportCSharp()
    {
        if (_base is null) return;
        var nodes = graph.Nodes.Select(x => x.Value).ToList();
        _exportJson = FlowSerializer.SerializeFlow(nodes);
    }

    private async Task ImportCSharp()
    {
        if (_base is null || string.IsNullOrWhiteSpace(_importJson)) return;

        try
        {
            _importError = null;
            var nodes = FlowSerializer.DeserializeFlow(_importJson);

            // Clear existing graph
            await _base.CallAsync<object>("clear");

            // Import nodes to drawflow
            var json = DrawflowExporter.ExportToDrawflowJson(nodes);
            await _base.CallAsync("import", json);
            await _base.JS.InvokeVoidAsync("nextFrame");

            // Re-apply port labels for nodes with multiple outputs
            foreach (var node in nodes)
            {
                if (node.DeclaredOutputPorts.Count > 0)
                {
                    await _base.JS.InvokeVoidAsync("DrawflowBlazor.labelPorts", _base.Id, node.DrawflowNodeId, new List<List<string>>(), node.DeclaredOutputPorts.Select(x => new List<string>() { x, "" }));
                }
            }

            showImportModal = false;
            _importJson = null;
        }
        catch (Exception ex)
        {
            _importError = $"Import failed: {ex.Message}";
        }
    }

    private async Task CopyToClipboard()
    {
        if (_base is null || string.IsNullOrWhiteSpace(_exportJson)) return;
        await _base.JS.InvokeVoidAsync("navigator.clipboard.writeText", _exportJson);
    }

    private async Task Clear()
    {
        if (_base is null) return;
        await _base.CallAsync<object>("clear");
        _exportJson = null;
    }
}
